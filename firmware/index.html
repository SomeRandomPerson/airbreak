<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Firmware - airbreak</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/docco.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">airbreak</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../disassembly/">Disassembly</a>
</li>
                                    
<li class="active">
    <a href="./">Firmware</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Information <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#">Hardware</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../info/datasheets/">Datasheets</a>
</li>
            
<li >
    <a href="../info/pinouts/">Pinouts</a>
</li>
            
<li >
    <a href="../info/testpoints/">Useful Test Points</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Software</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../info/tcl/">OpenOCD Scripts</a>
</li>
            
<li >
    <a href="../info/windows/">Windows Setup Instructions</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Firmware</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../info/firmware-docs/">Documentation</a>
</li>
            
<li >
    <a href="../info/extensions/">Development</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../disassembly/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../info/datasheets/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/osresearch/airbreak/"><i class="fa fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#firmware">Firmware</a></li>
            <li><a href="#connecting-to-device">Connecting to Device</a></li>
            <li><a href="#dumping-vendor-firmware">Dumping Vendor Firmware</a></li>
            <li><a href="#building-alternate-firmware">Building Alternate Firmware</a></li>
            <li><a href="#flashing">Flashing</a></li>
            <li><a href="#testing">Testing</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="firmware">Firmware</h1>
<h3 id="connecting-to-device">Connecting to Device</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are using Windows, the steps in this section will be slightly different. Please see the <a href="../info/windows/">Windows guide</a> for more information.</p>
</div>
<p>We are going to use the open-source OpenOCD debug interface to access the device.  </p>
<p>First, make sure <a href="https://github.com/osresearch/airbreak">this repository</a> is cloned and set to your current working directory.</p>
<p>Make sure your programmer is <a href="/disassembly/#wiring">attached to the PCB</a>, then start OpenOCD.</p>
<pre><code class="sh">sudo openocd -f interface/stlink.cfg -c 'tcl/airsense.cfg'
</code></pre>

<p>If your device is connected properly, you should see a bunch of output, ending with:</p>
<pre><code class="sh">Info : stm32f4x.cpu: hardware has 6 breakpoints, 4 watchpoints
</code></pre>

<p>In another terminal, connect to the OpenOCD server:</p>
<pre><code class="sh">telnet localhost 4444
</code></pre>

<p>Once your OpenOCD console is successfully connected, you can continue to the next step.</p>
<h2 id="dumping-vendor-firmware">Dumping Vendor Firmware</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This step is mandatory. Each subsequent step requires an original copy of the device firmware
to be present in the working directory. With an original copy of the firmware, the device can always be
restored to factory settings. If you lose the original firmware, you risk bricking your device!</p>
</div>
<p>Type <code>dump</code> into the OpenOCD console.</p>
<h2 id="building-alternate-firmware">Building Alternate Firmware</h2>
<h2 id="flashing">Flashing</h2>
<p><img alt="Unlocked icon" src="../images/unlocked.png" /></p>
<p>With the device powered up and the stlink connected to the computer, run <a href="http://openocd.org/">OpenOCD</a>
to initialize the programmer and fetch the existing firmware (should take about 10 seconds):</p>
<pre><code>sudo openocd \
    -f interface/stlink.cfg \
    -f target/stm32f4x.cfg \
    -c 'flash read_bank 0 stm32.bin'
</code></pre>

<p>Patch this extracted firmware with the script <a href="patch-airsense"><code>patch-airsense</code> script</a>
that will unlock the vendor modes and configuration bits:</p>
<pre><code>./patch-airsense stm32.bin stm32-unlocked.bin
</code></pre>

<p>Now reflash the device with the modified firmware:</p>
<pre><code>sudo openocd \
    -f interface/stlink.cfg \
    -f target/stm32f4x.cfg \
    -c 'stm32f2x options_write 0 0x2c' \
    -c 'reset halt' \
    -c 'flash write_image erase stm32-unlocked.bin 0x8000000' \
    -c 'reset run' \
</code></pre>

<h2 id="testing">Testing</h2>
<p><img alt="iVAPS mode unlocked" src="../images/airsense-ivaps.jpg" /></p>
<p>The device should reboot and if you enter the clinician menu (hold down the <code>Home</code> button while pushing on the knob
for three seconds), you should be able to select from all of the vendor modes, including iVAPS and ST.
These modes should allow the CPAP device to immediately be used according to the Mt Sinai BiPAP protocol.</p>
<p>The flashing is a one-time operation.  The programmer can be unplugged and moved to another device.</p>
<h3 id="restoring-the-vendor-firmware">Restoring the vendor firmware</h3>
<p><img alt="Gears icon" src="../images/gears.png" /></p>
<p>Restoring the old firmware is possible; there are some RTC variables that need to be adjusted.
Script to be provided.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
